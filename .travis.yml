language: node_js
node_js:
  - "10"
addons:
  apt:
    update: true
    packages:
    - genisoimage
    
branches:
  only:
    - master
    #- stable
    #- develop
    - travisci


before_install:
  - printenv
  - ls -al
  - cd src
  - npm install
  - cd ..
  - pip install --user configparser pandas pillow
  - wget -O=mypois-master.tar.gz https://github.com/jimmyH/mypois/archive/master.tar.gz
  - tar -xzf mypois-master.tar.gz
  - rm mypois-master.tar.gz
  - ls -al

install:
  - ls -al
  ############################################
  - rm -rf ./BUILD
  - mkdir ./BUILD
  - rm -rf ./RELEASES
  - mkdir ./RELEASES
  ############################################
  - node ./src/build.js
  - ls -alR ./BUILD
  ############################################
  - ls -al

before_script:
  - ls -al

script: 
  - ls -al
  ############################################
  - zip -r ./RELEASES/all_files.zip ./BUILD
  - ./make_zip.sh csv
  - ./make_zip.sh gpx
  - ./make_zip.sh ov2
  - ls -alR ./RELEASES
  ############################################
  - ./make_mypois.sh
  - cat ./config.ini
  - ls -alR ./BUILD_csv_h
  - python ./mypois-master/mypois.py ./config.ini
  - rm ./config.ini
  - rm -rf ./BUILD_csv_h
  - ls -alR ./SD_CARD
  ############################################
  - zip -r ./RELEASES/sd_files.zip SD_CARD
  - genisoimage -o sd_image.iso SD_CARD
  - zip -r ./RELEASES/sd_image.iso.zip sd_image.iso
  - ls -alR ./RELEASES
  ############################################
  - node ./src/update_doc.js
  ############################################
  - rm -rf ./mypois-master
  ############################################
  - ls -al

before_deploy:
  - export GATSO_UPDATE_MAX=`date -d @$(cat ./BUILD/version.txt | sort -n | tail -1) +%Y-%m-%d`
  - "[[ $TRAVIS_TAG ]] || export TRAVIS_TAG=\"${TAG_PREFIX}${TRAVIS_BRANCH}.${GATSO_UPDATE_MAX}\""
  - git config --local user.name "$USER_NAME"
  - git config --local user.email "$USER_EMAIL"
  #- git tag --force "$TRAVIS_TAG" $TRAVIS_COMMIT
  - export RELEASE_DESCRIPTION=`cat ./BUILD/manifest.txt`

deploy:
  - provider: releases
    api_key: $GITHUB_TOKEN
    name: $TRAVIS_TAG
    #body: "$RELEASE_DESCRIPTION" # https://github.com/travis-ci/dpl/issues/155
    overwrite: true
    tags: false
    prerelease: true
    skip_cleanup: true
    file:
      - "./RELEASES/all_files.zip"
      - "./RELEASES/sd_image.iso.zip"
    on:
      tags: false
      branch: 
        - master
        - travisci
  - provider: releases
    api_key: $GITHUB_TOKEN
    name: $TRAVIS_TAG
    #body: "$RELEASE_DESCRIPTION" # https://github.com/travis-ci/dpl/issues/155
    overwrite: true
    prerelease: false
    skip_cleanup: true
    file_glob: true
    file: "./RELEASES/*"
    on:
      tags: true
  - provider: pages
    github-token: $GITHUB_TOKEN
    skip-cleanup: true
    keep-history: true
    #target-branch: $TRAVIS_BRANCH
    on:
      branch: 
        - master

after_deploy:
  - ls -al

after_script:
  - ls -al
